services:
  mariadb:
    build: ./requirements/mariadb
    image: mariadb:1.0
    container_name: mariadb
    env_file: .env
    environment:
    - MYSQL_DATABASE=${MYSQL_DATABASE}
    - MYSQL_USER=${MYSQL_USER}
    - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${MYSQL_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  wordpress:
    build: ./requirements/wordpress
    image: wordpress:1.0
    container_name: wordpress
    env_file: .env
    environment:
    - MYSQL_HOST=mariadb
    - MYSQL_DATABASE=${MYSQL_DATABASE}
    - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
    - MYSQL_USER=${MYSQL_USER}
    - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    - MYSQL_EMAIL=${MYSQL_EMAIL}
    - WP_SECONDARY_USER=${WP_SECONDARY_USER}
    - WP_SECONDARY_USER_EMAIL=${WP_SECONDARY_USER_EMAIL}
    - WP_SECONDARY_USER_PASSWORD=${WP_SECONDARY_USER_PASSWORD}
    depends_on:
      - mariadb
    volumes:
      - wp_data:/var/www/html
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect localhost:9000 | grep -q pong || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  nginx:
    build: ./requirements/nginx
    image: nginx:1.0
    container_name: nginx
    env_file: .env
    environment:
    - DOMAIN_NAME=${DOMAIN_NAME}
    ports:
      - "443:443"
    depends_on:
      - wordpress
      - static-site
    volumes:
      - wp_data:/var/www/html
      - static_site:/var/www/public
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:443/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  redis:
    build: ./requirements/redis
    image: redis:1.0
    container_name: redis
    volumes:
      - redis_data:/data
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "healthcheck_counter"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  ftp:
    build: ./requirements/ftp
    image: ftp:1.0
    container_name: ftp
    env_file: .env
    environment:
    - FTP_USER=${FTP_USER}
    - FTP_PASS=${FTP_PASS}
    ports:
      - "21:21"                  # Command port
      - "40000-40099:40000-40099"  # Passive ports (match CMD flag)
    volumes:
      - wp_data:/var/www/html
    networks:
      - inception
    restart: always
    depends_on:
      - wordpress
    healthcheck:
      test: ["CMD-SHELL", "bin/bash", "-c", "2>/dev/null echo >/dev/tcp/127.0.0.1/22 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  static-site:
    build: ./requirements/static-site
    image: static-site:1.0
    container_name: static_site
    volumes:
      - static_site:/var/www/portfolio/public
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "test -d /var/www/portfolio/public && test -r /var/www/portfolio/public"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  adminer:
    build: ./requirements/adminer
    image: adminer:1.0
    container_name: adminer
    networks:
      - inception
    restart: always
    depends_on:
      - mariadb
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 15s

  portainer:
    build: ./requirements/portainer
    image: portainer:1.0
    container_name: portainer
    env_file: .env
    environment:
    - PORTAINER_ADMIN_PASSWORD=${PORTAINER_ADMIN_PASSWORD}
    networks:
      - inception
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - portainer_data:/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:9443/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  wp_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/wordpress
  db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/mariadb
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/redis
  static_site:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/static_site
  portainer_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/portainer
networks:
  inception:
    name: inception
    driver: bridge