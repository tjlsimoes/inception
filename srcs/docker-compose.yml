services:
  mariadb:
    build: ./requirements/mariadb
    image: mariadb:1.0
    container_name: mariadb
    env_file: .env
    environment:
    - MYSQL_DATABASE_FILE=/run/secrets/mysql_database
    - MYSQL_USER_FILE=/run/secrets/mysql_user
    - MYSQL_ROOT_PASSWORD_FILE=/run/secrets/mysql_root_password
    - MYSQL_PASSWORD_FILE=/run/secrets/mysql_password
    volumes:
      - db_data:/var/lib/mysql
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u \"$(cat /run/secrets/mysql_user)\" --password=\"$(cat /run/secrets/mysql_password)\" --silent || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    secrets:
      - mysql_database
      - mysql_user
      - mysql_root_password
      - mysql_password

  wordpress:
    build: ./requirements/wordpress
    image: wordpress:1.0
    container_name: wordpress
    env_file: .env
    environment:
      - MYSQL_HOST=mariadb
      - DOMAIN_NAME=${DOMAIN_NAME}
      - MYSQL_DATABASE_FILE=/run/secrets/mysql_database
      - MYSQL_USER_FILE=/run/secrets/mysql_user
      - MYSQL_PASSWORD_FILE=/run/secrets/mysql_password
      - MYSQL_EMAIL_FILE=/run/secrets/mysql_email
      - WP_SECONDARY_USER_FILE=/run/secrets/wp_secondary_user
      - WP_SECONDARY_USER_EMAIL_FILE=/run/secrets/wp_secondary_user_email
      - WP_SECONDARY_USER_PASSWORD_FILE=/run/secrets/wp_secondary_user_password
    depends_on:
      - mariadb
    volumes:
      - wp_data:/var/www/html
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "SCRIPT_NAME=/ping SCRIPT_FILENAME=/ping REQUEST_METHOD=GET cgi-fcgi -bind -connect localhost:9000 | grep -q pong || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s
    secrets:
      - mysql_database
      - mysql_user
      - mysql_password
      - mysql_email
      - wp_secondary_user
      - wp_secondary_user_email
      - wp_secondary_user_password

  nginx:
    build: ./requirements/nginx
    image: nginx:1.0
    container_name: nginx
    env_file: .env
    environment:
    - DOMAIN_NAME=${DOMAIN_NAME}
    ports:
      - "443:443"
    depends_on:
      - wordpress
      - static-site
    volumes:
      - wp_data:/var/www/html
      - static_site:/var/www/public
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:443/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

  redis:
    build: ./requirements/redis
    image: redis:1.0
    container_name: redis
    volumes:
      - redis_data:/data
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "healthcheck_counter"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  ftp:
    build: ./requirements/ftp
    image: ftp:1.0
    container_name: ftp
    env_file: .env
    environment:
    - FTP_USER_FILE=/run/secrets/ftp_user
    - FTP_PASS_FILE=/run/secrets/ftp_password
    ports:
      - "21:21"                  # Command port
      - "40000-40099:40000-40099"  # Passive ports (match CMD flag)
    volumes:
      - wp_data:/var/www/html
    networks:
      - inception
    restart: always
    depends_on:
      - wordpress
    healthcheck:
      test: ["CMD-SHELL", "bin/bash", "-c", "2>/dev/null echo >/dev/tcp/127.0.0.1/21 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    secrets:
      - ftp_user
      - ftp_password

  static-site:
    build: ./requirements/static-site
    image: static-site:1.0
    container_name: static_site
    volumes:
      - static_site:/var/www/portfolio/public
    networks:
      - inception
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "test -d /var/www/portfolio/public && test -r /var/www/portfolio/public"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  adminer:
    build: ./requirements/adminer
    image: adminer:1.0
    container_name: adminer
    networks:
      - inception
    restart: always
    depends_on:
      - mariadb
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 15s

  portainer:
    build: ./requirements/portainer
    image: portainer:1.0
    container_name: portainer
    env_file: .env
    environment:
    - PORTAINER_ADMIN_PASSWORD_FILE=/run/secrets/portainer_admin_password
    networks:
      - inception
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - portainer_data:/data
    restart: always
    healthcheck:
      test: ["CMD-SHELL", "curl -f -k https://localhost:9443/ || exit 1"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    secrets:
      - portainer_admin_password

volumes:
  wp_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/wordpress
  db_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/mariadb
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/redis
  static_site:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/static_site
  portainer_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /home/${LOGIN}/data/portainer
networks:
  inception:
    name: inception
    driver: bridge

secrets:
  mysql_database:
    file: ../secrets/mysql_database.txt
  mysql_user:
    file: ../secrets/mysql_user.txt
  mysql_root_password:
    file: ../secrets/mysql_root_password.txt
  mysql_password:
    file: ../secrets/mysql_password.txt
  mysql_email:
    file: ../secrets/mysql_email.txt
  wp_secondary_user:
    file: ../secrets/wp_secondary_user.txt
  wp_secondary_user_email:
    file: ../secrets/wp_secondary_user_email.txt
  wp_secondary_user_password:
    file: ../secrets/wp_secondary_user_password.txt
  ftp_user:
    file: ../secrets/ftp_user.txt
  ftp_password:
    file: ../secrets/ftp_password.txt
  portainer_admin_password:
    file: ../secrets/portainer_admin_password.txt